{"fields.level":"warning","level":"warning","msg":"Generated random JWT_SECRET for non-production (set JWT_SECRET to persist sessions)","time":"2025-12-14T09:59:01.255-03:00","type":"warn"}
=== RUN   TestLoginHandler
=== RUN   TestLoginHandler/successful_login
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:01.375-03:00","type":"info","username":"admin"}
{"idp":"core","level":"info","msg":"Login successful","role":"admin","time":"2025-12-14T09:59:01.486-03:00","type":"info","username":"admin"}
=== RUN   TestLoginHandler/invalid_JSON_body
=== RUN   TestLoginHandler/invalid_credentials
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:01.486-03:00","type":"info","username":"admin"}
=== RUN   TestLoginHandler/setup_mode_blocks_login
=== RUN   TestLoginHandler/auth_service_not_initialized
--- PASS: TestLoginHandler (0.31s)
    --- PASS: TestLoginHandler/successful_login (0.11s)
    --- PASS: TestLoginHandler/invalid_JSON_body (0.00s)
    --- PASS: TestLoginHandler/invalid_credentials (0.08s)
    --- PASS: TestLoginHandler/setup_mode_blocks_login (0.00s)
    --- PASS: TestLoginHandler/auth_service_not_initialized (0.00s)
=== RUN   TestLogoutHandler
=== RUN   TestLogoutHandler/successful_logout_with_POST
=== RUN   TestLogoutHandler/invalid_method_GET
=== RUN   TestLogoutHandler/invalid_method_PUT
--- PASS: TestLogoutHandler (0.00s)
    --- PASS: TestLogoutHandler/successful_logout_with_POST (0.00s)
    --- PASS: TestLogoutHandler/invalid_method_GET (0.00s)
    --- PASS: TestLogoutHandler/invalid_method_PUT (0.00s)
=== RUN   TestMeHandler
=== RUN   TestMeHandler/authenticated_user
{"level":"info","msg":"GetCurrentUser: extracted from AuthClaims","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.628-03:00","type":"info","username":"admin"}
{"level":"info","msg":"GetCurrentUser: returning claims","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.628-03:00","type":"info","username":"admin"}
{"idp":"","level":"info","msg":"MeHandler: returning user info","permissions":{},"role":"admin","time":"2025-12-14T09:59:01.628-03:00","type":"info","username":"admin"}
=== RUN   TestMeHandler/no_user_in_context
=== RUN   TestMeHandler/setup_mode_blocks_access
=== RUN   TestMeHandler/auth_service_not_initialized
--- PASS: TestMeHandler (0.07s)
    --- PASS: TestMeHandler/authenticated_user (0.00s)
    --- PASS: TestMeHandler/no_user_in_context (0.00s)
    --- PASS: TestMeHandler/setup_mode_blocks_access (0.00s)
    --- PASS: TestMeHandler/auth_service_not_initialized (0.00s)
=== RUN   TestChangePasswordHandler
=== RUN   TestChangePasswordHandler/setup_mode_blocks_access
=== RUN   TestChangePasswordHandler/K8s_repo_not_available
=== RUN   TestChangePasswordHandler/unauthorized_user_-_K8s_repo_checked_first
--- PASS: TestChangePasswordHandler (0.08s)
    --- PASS: TestChangePasswordHandler/setup_mode_blocks_access (0.00s)
    --- PASS: TestChangePasswordHandler/K8s_repo_not_available (0.00s)
    --- PASS: TestChangePasswordHandler/unauthorized_user_-_K8s_repo_checked_first (0.00s)
=== RUN   TestChangePasswordHandler_WithK8s
=== RUN   TestChangePasswordHandler_WithK8s/Success
{"level":"info","msg":"GetCurrentUser: extracted from AuthClaims","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.728-03:00","type":"info","username":"admin"}
{"level":"info","msg":"GetCurrentUser: returning claims","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.728-03:00","type":"info","username":"admin"}
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:01.728-03:00","type":"info","username":"admin"}
{"idp":"core","level":"info","msg":"Login successful","role":"admin","time":"2025-12-14T09:59:01.749-03:00","type":"info","username":"admin"}
{"level":"info","msg":"Password updated in Kubernetes secret","namespace":"default","secret_name":"dkonsole-auth","time":"2025-12-14T09:59:01.770-03:00","type":"info"}
{"level":"info","msg":"Password changed successfully","time":"2025-12-14T09:59:01.770-03:00","type":"info","username":"admin"}
=== RUN   TestChangePasswordHandler_WithK8s/Wrong_Current_Password
{"level":"info","msg":"GetCurrentUser: extracted from AuthClaims","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.770-03:00","type":"info","username":"admin"}
{"level":"info","msg":"GetCurrentUser: returning claims","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.770-03:00","type":"info","username":"admin"}
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:01.770-03:00","type":"info","username":"admin"}
=== RUN   TestChangePasswordHandler_WithK8s/Short_New_Password
=== RUN   TestChangePasswordHandler_WithK8s/No_Token
--- PASS: TestChangePasswordHandler_WithK8s (0.09s)
    --- PASS: TestChangePasswordHandler_WithK8s/Success (0.04s)
    --- PASS: TestChangePasswordHandler_WithK8s/Wrong_Current_Password (0.02s)
    --- PASS: TestChangePasswordHandler_WithK8s/Short_New_Password (0.00s)
    --- PASS: TestChangePasswordHandler_WithK8s/No_Token (0.00s)
=== RUN   TestJWTService_ValidateToken
=== RUN   TestJWTService_ValidateToken/valid_token
=== RUN   TestJWTService_ValidateToken/expired_token
=== RUN   TestJWTService_ValidateToken/invalid_signature
=== RUN   TestJWTService_ValidateToken/malformed_token
=== RUN   TestJWTService_ValidateToken/empty_token
--- PASS: TestJWTService_ValidateToken (0.00s)
    --- PASS: TestJWTService_ValidateToken/valid_token (0.00s)
    --- PASS: TestJWTService_ValidateToken/expired_token (0.00s)
    --- PASS: TestJWTService_ValidateToken/invalid_signature (0.00s)
    --- PASS: TestJWTService_ValidateToken/malformed_token (0.00s)
    --- PASS: TestJWTService_ValidateToken/empty_token (0.00s)
=== RUN   TestJWTService_ExtractToken
=== RUN   TestJWTService_ExtractToken/token_in_Authorization_header
=== RUN   TestJWTService_ExtractToken/token_in_query_parameter
=== RUN   TestJWTService_ExtractToken/token_in_access_token_query_parameter
=== RUN   TestJWTService_ExtractToken/token_in_Sec-WebSocket-Protocol_header
=== RUN   TestJWTService_ExtractToken/token_in_cookie
=== RUN   TestJWTService_ExtractToken/no_token
--- PASS: TestJWTService_ExtractToken (0.00s)
    --- PASS: TestJWTService_ExtractToken/token_in_Authorization_header (0.00s)
    --- PASS: TestJWTService_ExtractToken/token_in_query_parameter (0.00s)
    --- PASS: TestJWTService_ExtractToken/token_in_access_token_query_parameter (0.00s)
    --- PASS: TestJWTService_ExtractToken/token_in_Sec-WebSocket-Protocol_header (0.00s)
    --- PASS: TestJWTService_ExtractToken/token_in_cookie (0.00s)
    --- PASS: TestJWTService_ExtractToken/no_token (0.00s)
=== RUN   TestJWTService_AuthenticateRequest
=== RUN   TestJWTService_AuthenticateRequest/valid_token_in_header
=== RUN   TestJWTService_AuthenticateRequest/no_token
=== RUN   TestJWTService_AuthenticateRequest/invalid_token
--- PASS: TestJWTService_AuthenticateRequest (0.00s)
    --- PASS: TestJWTService_AuthenticateRequest/valid_token_in_header (0.00s)
    --- PASS: TestJWTService_AuthenticateRequest/no_token (0.00s)
    --- PASS: TestJWTService_AuthenticateRequest/invalid_token (0.00s)
=== RUN   TestK8sUserRepository_GetAdminUserAndPassword
--- PASS: TestK8sUserRepository_GetAdminUserAndPassword (0.00s)
=== RUN   TestK8sUserRepository_SecretExistsAndCreateSecret
{"level":"info","msg":"Creating Kubernetes secret","namespace":"ns-create","secret_name":"dkonsole-auth","time":"2025-12-14T09:59:01.795-03:00","type":"info","username":"admin","using_token":true}
    k8s_repository_test.go:85: CreateSecret returned error: failed to create secret: Post "https:///api/v1/namespaces/ns-create/secrets": http: no Host in request URL
--- FAIL: TestK8sUserRepository_SecretExistsAndCreateSecret (0.00s)
=== RUN   TestEnvUserRepository
--- PASS: TestEnvUserRepository (0.00s)
=== RUN   TestUserContextKey
--- PASS: TestUserContextKey (0.00s)
=== RUN   TestAuthMiddleware
=== RUN   TestAuthMiddleware/Setup_Mode_Active
=== RUN   TestAuthMiddleware/JWT_Service_Not_Initialized
=== RUN   TestAuthMiddleware/OPTIONS_Request
=== RUN   TestAuthMiddleware/No_Token
=== RUN   TestAuthMiddleware/Invalid_Token
=== RUN   TestAuthMiddleware/Valid_Admin_Token
{"level":"info","msg":"AuthMiddleware: extracted claims from JWT","permissions":null,"role":"admin","time":"2025-12-14T09:59:01.796-03:00","type":"info","username":"admin"}
--- PASS: TestAuthMiddleware (0.00s)
    --- PASS: TestAuthMiddleware/Setup_Mode_Active (0.00s)
    --- PASS: TestAuthMiddleware/JWT_Service_Not_Initialized (0.00s)
    --- PASS: TestAuthMiddleware/OPTIONS_Request (0.00s)
    --- PASS: TestAuthMiddleware/No_Token (0.00s)
    --- PASS: TestAuthMiddleware/Invalid_Token (0.00s)
    --- PASS: TestAuthMiddleware/Valid_Admin_Token (0.00s)
=== RUN   TestVerifyPassword
=== RUN   TestVerifyPassword/correct_password
=== RUN   TestVerifyPassword/wrong_password
=== RUN   TestVerifyPassword/invalid_hash_format_-_too_few_parts
=== RUN   TestVerifyPassword/unsupported_variant
=== RUN   TestVerifyPassword/incompatible_version
=== RUN   TestVerifyPassword/invalid_base64_salt
=== RUN   TestVerifyPassword/invalid_base64_hash
--- PASS: TestVerifyPassword (0.22s)
    --- PASS: TestVerifyPassword/correct_password (0.07s)
    --- PASS: TestVerifyPassword/wrong_password (0.08s)
    --- PASS: TestVerifyPassword/invalid_hash_format_-_too_few_parts (0.00s)
    --- PASS: TestVerifyPassword/unsupported_variant (0.00s)
    --- PASS: TestVerifyPassword/incompatible_version (0.00s)
    --- PASS: TestVerifyPassword/invalid_base64_salt (0.00s)
    --- PASS: TestVerifyPassword/invalid_base64_hash (0.00s)
=== RUN   TestNewService
=== RUN   TestNewService/Initialize_with_K8s_client_-_Secret_Missing_(Setup_Mode)
{"level":"info","msg":"Running in setup mode - secret does not exist","secret_name":"dkonsole-auth","time":"2025-12-14T09:59:02.011-03:00","type":"info"}
=== RUN   TestNewService/Initialize_with_K8s_client_-_Secret_Exists
=== RUN   TestNewService/Initialize_without_K8s_client_(Env_Fallback)
--- PASS: TestNewService (0.00s)
    --- PASS: TestNewService/Initialize_with_K8s_client_-_Secret_Missing_(Setup_Mode) (0.00s)
    --- PASS: TestNewService/Initialize_with_K8s_client_-_Secret_Exists (0.00s)
    --- PASS: TestNewService/Initialize_without_K8s_client_(Env_Fallback) (0.00s)
=== RUN   TestAuthService_Login
=== RUN   TestAuthService_Login/successful_login
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.095-03:00","type":"info","username":"admin"}
{"idp":"core","level":"info","msg":"Login successful","role":"admin","time":"2025-12-14T09:59:02.169-03:00","type":"info","username":"admin"}
=== RUN   TestAuthService_Login/invalid_username
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.169-03:00","type":"info","username":"wronguser"}
=== RUN   TestAuthService_Login/invalid_password
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.169-03:00","type":"info","username":"admin"}
=== RUN   TestAuthService_Login/missing_admin_user
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"admin"}
=== RUN   TestAuthService_Login/missing_admin_password
{"idp":"","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"admin"}
--- PASS: TestAuthService_Login (0.23s)
    --- PASS: TestAuthService_Login/successful_login (0.07s)
    --- PASS: TestAuthService_Login/invalid_username (0.00s)
    --- PASS: TestAuthService_Login/invalid_password (0.07s)
    --- PASS: TestAuthService_Login/missing_admin_user (0.00s)
    --- PASS: TestAuthService_Login/missing_admin_password (0.00s)
=== RUN   TestAuthService_GetCurrentUser
=== RUN   TestAuthService_GetCurrentUser/valid_user_in_context
{"level":"info","msg":"GetCurrentUser: extracted from AuthClaims","permissions":null,"role":"admin","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"admin"}
{"level":"info","msg":"GetCurrentUser: returning claims","permissions":null,"role":"admin","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"admin"}
=== RUN   TestAuthService_GetCurrentUser/no_user_in_context
=== RUN   TestAuthService_GetCurrentUser/invalid_user_type_in_context
--- PASS: TestAuthService_GetCurrentUser (0.00s)
    --- PASS: TestAuthService_GetCurrentUser/valid_user_in_context (0.00s)
    --- PASS: TestAuthService_GetCurrentUser/no_user_in_context (0.00s)
    --- PASS: TestAuthService_GetCurrentUser/invalid_user_type_in_context (0.00s)
=== RUN   TestAuthService_LoginWithLDAP
=== RUN   TestAuthService_LoginWithLDAP/successful_LDAP_login_with_no_permissions_(empty_map)
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
{"idp":"ldap","level":"info","msg":"Login successful","role":"user","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
=== RUN   TestAuthService_LoginWithLDAP/successful_LDAP_login_with_admin_permissions_(nil)
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
{"idp":"ldap","level":"info","msg":"Login successful","role":"admin","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
=== RUN   TestAuthService_LoginWithLDAP/successful_LDAP_login_with_user_permissions
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
{"idp":"ldap","level":"info","msg":"Login successful","role":"user","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
=== RUN   TestAuthService_LoginWithLDAP/LDAP_authentication_failed
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
{"error":"invalid credentials","level":"warning","msg":"LDAP authentication failed","time":"2025-12-14T09:59:02.241-03:00","type":"warn","username":"ldapuser"}
=== RUN   TestAuthService_LoginWithLDAP/LDAP_disabled
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
=== RUN   TestAuthService_LoginWithLDAP/user_not_in_required_group
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
{"error":"user not in required group","level":"warning","msg":"LDAP user validation failed","time":"2025-12-14T09:59:02.241-03:00","type":"warn","username":"ldapuser"}
=== RUN   TestAuthService_LoginWithLDAP/failed_to_get_permissions,_continues_as_user
{"idp":"ldap","level":"info","msg":"Login attempt","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
{"error":"failed to get permissions","level":"warning","msg":"Failed to get user permissions","time":"2025-12-14T09:59:02.241-03:00","type":"warn","username":"ldapuser"}
{"idp":"ldap","level":"info","msg":"Login successful","role":"user","time":"2025-12-14T09:59:02.241-03:00","type":"info","username":"ldapuser"}
--- PASS: TestAuthService_LoginWithLDAP (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/successful_LDAP_login_with_no_permissions_(empty_map) (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/successful_LDAP_login_with_admin_permissions_(nil) (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/successful_LDAP_login_with_user_permissions (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/LDAP_authentication_failed (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/LDAP_disabled (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/user_not_in_required_group (0.00s)
    --- PASS: TestAuthService_LoginWithLDAP/failed_to_get_permissions,_continues_as_user (0.00s)
=== RUN   TestSetupStatusHandler
--- PASS: TestSetupStatusHandler (0.00s)
=== RUN   TestSetupCompleteHandler_Success
{"ip":"192.0.2.1:1234","level":"info","method":"POST","msg":"SetupCompleteHandler called","path":"/api/setup/complete","time":"2025-12-14T09:59:02.241-03:00","type":"info"}
{"endpoint":"/api/setup/complete","level":"info","msg":"Checking if secret exists before setup","time":"2025-12-14T09:59:02.241-03:00","type":"info"}
{"exists":false,"level":"info","msg":"Secret existence check completed","time":"2025-12-14T09:59:02.241-03:00","type":"info"}
{"level":"info","msg":"Attempting to create secret","namespace":"setup-ns","secret_name":"dkonsole-auth","time":"2025-12-14T09:59:02.260-03:00","type":"info","username":"admin"}
{"level":"info","msg":"Creating Kubernetes secret","namespace":"setup-ns","secret_name":"dkonsole-auth","time":"2025-12-14T09:59:02.261-03:00","type":"info","username":"admin","using_token":true}
{"error":"failed to create secret: Post \"https:///api/v1/namespaces/setup-ns/secrets\": http: no Host in request URL","error_message":"failed to create secret: Post \"https:///api/v1/namespaces/setup-ns/secrets\": http: no Host in request URL","error_type":"*fmt.wrapError","level":"error","message":"Failed to create secret","msg":"Failed to create secret","time":"2025-12-14T09:59:02.261-03:00","type":"error","username":"admin"}
    setup_test.go:96: status = 500, want 200, body={"error":"Failed to create secret: failed to create secret: Post \"https:///api/v1/namespaces/setup-ns/secrets\": http: no Host in request URL"}
--- FAIL: TestSetupCompleteHandler_Success (0.02s)
=== RUN   TestSetupCompleteHandler_ForbiddenWhenExists
{"ip":"192.0.2.1:1234","level":"info","method":"POST","msg":"SetupCompleteHandler called","path":"/api/setup/complete","time":"2025-12-14T09:59:02.261-03:00","type":"info"}
{"endpoint":"/api/setup/complete","level":"info","msg":"Checking if secret exists before setup","time":"2025-12-14T09:59:02.261-03:00","type":"info"}
{"exists":true,"level":"info","msg":"Secret existence check completed","time":"2025-12-14T09:59:02.261-03:00","type":"info"}
{"endpoint":"/api/setup/complete","level":"warning","msg":"Setup attempted but secret already exists","time":"2025-12-14T09:59:02.261-03:00","type":"warn"}
--- PASS: TestSetupCompleteHandler_ForbiddenWhenExists (0.00s)
=== RUN   TestUpdateTokenHandler
{"error":"failed to get secret (using new token): Get \"https:///api/v1/namespaces/setup-ns/secrets/dkonsole-auth\": http: no Host in request URL","level":"error","message":"Failed to update token","msg":"Failed to update token","time":"2025-12-14T09:59:02.261-03:00","type":"error"}
    setup_test.go:133: UpdateTokenHandler failed as expected in unit test env: {"error":"Failed to update token: failed to get secret (using new token): Get \"https:///api/v1/namespaces/setup-ns/secrets/dkonsole-auth\": http: no Host in request URL"}
--- PASS: TestUpdateTokenHandler (0.00s)
FAIL
FAIL	github.com/flaucha/DKonsole/backend/internal/auth	1.033s
FAIL
